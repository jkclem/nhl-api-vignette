---
title: "NHL API Vignette"
author: "John Clements"
date: "6/15/2021"
output: 
  html_document:
    toc: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Requirements

To use the functions for interacting with the [NHL API](https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md), you need to install and load:

- [`dplyr`](https://cran.r-project.org/web/packages/dplyr/): `data.frame` manipulation
- [`jsonlite`](https://cran.r-project.org/web/packages/jsonlite/): API interaction

Additionally, I used the following packages for the data exploration:

- [`ggplot2`](https://ggplot2.tidyverse.org/): data visualization
- [`cowplot`](https://cran.r-project.org/web/packages/cowplot/index.html): extra functionality for `ggplot2`
- [`imager`](https://cran.r-project.org/web/packages/imager/): loading in an images

I didn't pull in the entire [`tidyverse`](https://www.tidyverse.org/) to avoid pulling in unnecessary functions.

```{r warning=FALSE, message=FALSE}
library(jsonlite)
library(dplyr)
library(ggplot2)
library(cowplot)
library(imager)
```

# Functions

## `convertToNumeric`

I made this helper function to convert columns that contain numeric data stored as `character` values to numeric data types. I ran into an issue where my calls from the API were returning some numeric data as `character` data and needed a way to deal with this issue without just calling `as.numeric` as needed.

```{r}
convertToNumeric <- function(vec){
  ###
  # This function will convert the input vector to a numeric vector if it is 
  # able to. Otherwise, it just returns the vector.
  ###
  
  # If any of the values in vec return NA when trying to convert to numeric,
  # just return vec as the output.
  if (any(is.na(suppressWarnings(as.numeric(vec))) == TRUE)){
    output <- vec
  }
  # Otherwise, convert vec to a numeric vector.
  else {
    output <- as.numeric(vec)
  }
  return(output)
}
```

## `franchise`

I wrote this function to interact with the `franchise` endpoint of the [NHL Records API](https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md). It returns a `data.frame` containing the franchise and current team Id numbers, the name and abbreviations of teams, and their first and last seasons. It takes one argument; `team`, which can either be `"all"`, the full name of a team (e.g. `"New Jersey Devils"`), or the most recent team Id (e.g. `1` for the New Jersey Devils).

```{r}
franchise <- function(team="all"){
  ###
  # This functions returns a dataframe with metadata on all teams who ever 
  # played in the NHL. It can also return those columns for a single team if a 
  # franchise ID or name is passed.
  ###
  
  # Get the franchise data from the franchises endpoint.
  outputAPI <- fromJSON(
      "https://records.nhl.com/site/api/franchise"
      )
  
  # Select only the dataframe.
  output <- outputAPI$data
  
  # If team does not equal "all", check if it is a franchise ID or team name.
  if (team != "all"){
    
    # If team is in the id column, subset output for just that row.
    if (team %in% output$id){
      output <- output %>%
        filter(mostRecentTeamId == team)
    }
    # If team is in the fullName column, subset output for just that row.
    else if (team %in% output$fullName){
      output <- output %>%
        filter(fullName == team)
    }
    # Otherwise, warn the user and return the entire dataframe.
    else {
      message <- paste("ERROR: Argument for team was not found in either",
                       "the fullName or id columns. Try franchise('all') to",
                       "find the team you're looking for.")
      stop(message)
    }
  }
  # Do nothing if the team value equals "all".
  else {
    
  }
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output dataframe.
  return(output)
}
```

## `teamTotals`

I wrote this function to interact with the `franchise-team-totals` endpoint of the NHL Records API. It returns a large number of statistics for the entire history of a team for both regular season and playoff games. It takes one argument; `team`, which can either be `"all"`, the full name of a team (e.g. `"New Jersey Devils"`), or the most recent team Id (e.g. `1` for the New Jersey Devils).

```{r}
teamTotals <- function(team="all"){
  ###
  # This function returns total stats for every franchise (ex roadTies,
  # roadWins, etc) unless a specific team Id or full team name is passed.
  ###
  
  # Get the franchise data from the franchises endpoint.
  outputAPI <- fromJSON(
    "https://records.nhl.com/site/api/franchise-team-totals"
    )
  
  # Select only the dataframe.
  output <- outputAPI$data
  
  # If team does not equal "all", check if it is a team ID or team name.
  if (team != "all"){
    
    # If team is in the franchiseId column, subset output for just that row.
    if (team %in% output$teamId){
      output <- output %>%
        filter(teamId == team)
    }
    # If team is in the teamName column, subset output for just that row.
    else if (team %in% output$teamName){
      output <- output %>%
        filter(teamName == team)
    }
    # Otherwise, warn the user and return the entire dataframe.
    else {
      message <- paste("WARNING: Argument for team was not found in either",
                       "the teamName or franchiseId columns. Returning all",
                       "franchises.")
      warning(message)
    }
  }
  # Do nothing if the team value equals "all".
  else {
    
  }
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output dataframe.
  return(output)
}
```

## `findTeamId`

This is a helper function to look up the most recent team Id for a full team name (e.g. `"Boston Bruins"`) because I a didn't feel like hard coding it. It is used in the `franchiseDetail` and `seasonStats` functions because the endpoints they connect to use the most recent team Id to access team-level data in the API call.

```{r}
findTeamId <- function(teamName){
  ###
  # This helper function looks up the franchise id for a full team name 
  # e.g. "Boston Bruins".
  ###
  
  # Call the franchise function with the team name.
  teamId <- franchise(teamName)
  
  # Return only the most recent team id number.
  return(teamId$mostRecentTeamId)
}
```

## `findFranchiseId`

This is a helper function does the same thing as `findTeamId`, except for the franchise Id. It is used in the `seasonRecords`, `goalieRecords`, and `skaterRecords` functions because they use the franchise Id to access team-level data in the API call.

```{r}
findFranchiseId <- function(teamName){
  ###
  # This helper function looks up the franchise id for a full team name 
  # e.g. "Boston Bruins".
  ###
  
  # Call the franchise function with the team name.
  teamId <- franchise(teamName)
  
  # Return only the most recent team id number.
  return(teamId$id)
}
```

## `seasonRecords`

The `seasonRecords` function returns the records stats for a single team. For example, the most goals scored in a season and the season they scored it in. It takes one argument; `team`, which can either be the full name of a team (e.g. `"New Jersey Devils"`), or the **franchise Id** (e.g. `23` for the New Jersey Devils).

```{r}
seasonRecords <- function(team){
  ###
  # This functions returns a dataframe with the season records for a variety 
  # of stats for a single team.
  ###
  
  # If team is a "character" type, try to look up the team id.
  if (typeof(team) == "character"){
    teamId = findFranchiseId(team)
  }
  # If team is an integer, set teamId equal to team.
  else if ((typeof(team) == "double") & (team %% 1 == 0)){
    teamId = team
  }
  # Otherwise, throw an error.
  else {
    message <- paste("Please pass a team id (integer) or a full team name",
                     "e.g. 'Boston Bruins'.")
    stop(message)
  }
  
  # Set the base url, endpoint, and combine them with teamId for the full url.
  baseURL <- "https://records.nhl.com/site/api/"
  endpoint <- "franchise-season-records?cayenneExp=franchiseId="
  fullURL <- paste0(baseURL, endpoint, teamId)
  
  # Get the API output.
  outputAPI <- fromJSON(fullURL)
  # Select only the data.
  output <- outputAPI$data
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output from the request.
  return(output)
}
```

## `goalieRecords`

The `goalieRecords` function returns the stats for all the goalies who've played for a single team. For example, the most saves in a game and the date of the game. It takes one argument; `team`, which can either be the full name of a team (e.g. `"New Jersey Devils"`), or the **franchise Id** (e.g. `23` for the New Jersey Devils).

```{r}
goalieRecords <- function(team){
  ###
  # This functions returns a dataframe with the goalie records for a team.
  ###
  
  # If team is a "character" type, try to look up the team id.
  if (typeof(team) == "character"){
    teamId = findFranchiseId(team)
  }
  # If team is an integer, set teamId equal to team.
  else if ((typeof(team) == "double") & (team %% 1 == 0)){
    teamId = team
  }
  # Otherwise, throw an error.
  else {
    message <- paste("Please pass a team id (integer) or a full team name",
                     "e.g. 'Boston Bruins'.")
    stop(message)
  }
  
  # Set the base url, endpoint, and combine them with teamId for the full url.
  baseURL <- "https://records.nhl.com/site/api/"
  endpoint <- "franchise-goalie-records?cayenneExp=franchiseId="
  fullURL <- paste0(baseURL, endpoint, teamId)
  
  # Get the API output.
  outputAPI <- fromJSON(fullURL)
  # Select only the data.
  output <- outputAPI$data
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output from the request.
  return(output)
}
```

## `skaterRecords`

The `skaterRecords` function returns the stats for all the non-goalie players who've played for a single team. For example, the most penalty minutes they received in one season and the season the season it occurred in. It takes one argument; `team`, which can either be the full name of a team (e.g. `"New Jersey Devils"`), or the **franchise Id** (e.g. `23` for the New Jersey Devils).

```{r}
skaterRecords <- function(team){
  ###
  # This functions returns a dataframe with the skater records for a team.
  ###
  
  # If team is a "character" type, try to look up the team id.
  if (typeof(team) == "character"){
    teamId = findFranchiseId(team)
  }
  # If team is an integer, set teamId equal to team.
  else if ((typeof(team) == "double") & (team %% 1 == 0)){
    teamId = team
  }
  # Otherwise, throw an error.
  else {
    message <- paste("Please pass a team id (integer) or a full team name",
                     "e.g. 'Boston Bruins'.")
    stop(message)
  }
  
  # Set the base url, endpoint, and combine them with teamId for the full url.
  baseURL <- "https://records.nhl.com/site/api/"
  endpoint <- "franchise-skater-records?cayenneExp=franchiseId="
  fullURL <- paste0(baseURL, endpoint, teamId)
  
  # Get the API output.
  outputAPI <- fromJSON(fullURL)
  # Select only the data.
  output <- outputAPI$data
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output from the request.
  return(output)
}
```

## `franchiseDetail`

This function gets info for a franchise, like their retired numbers. It takes one argument; `team`, which can either be the full name of a team (e.g. `"New Jersey Devils"`), or the most recent team Id (e.g. `1` for the New Jersey Devils).

```{r}
franchiseDetail <- function(team){
  ###
  # This functions returns a dataframe with the data for a team.
  ###
  
  # If team is a "character" type, try to look up the team id.
  if (typeof(team) == "character"){
    teamId = findTeamId(team)
  }
  # If team is an integer, set teamId equal to team.
  else if ((typeof(team) == "double") & (team %% 1 == 0)){
    teamId = team
  }
  # Otherwise, throw an error.
  else {
    message <- paste("Please pass a team id (integer) or a full team name",
                     "e.g. 'Boston Bruins'.")
    stop(message)
  }
  
  # Set the base url, endpoint, and combine them with teamId for the full url.
  baseURL <- "https://records.nhl.com/site/api/"
  endpoint <- "franchise-detail?cayenneExp=mostRecentTeamId="
  fullURL <- paste0(baseURL, endpoint, teamId)
  
  # Get the API output.
  outputAPI <- fromJSON(fullURL)
  # Select only the data.
  output <- outputAPI$data
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output from the request.
  return(output)
}
```

## `seasonStats`

I wrote this function to interact with the `franchise` endpoint of the [NHL Stats API](https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md). It returns a `data.frame` containing the current season stats. It takes one argument; `team`, which can either be `"all"`, the full name of a team (e.g. `"New Jersey Devils"`), or the most recent team Id (e.g. `1` for the New Jersey Devils).

```{r}
seasonStats <- function(team="all", raw=FALSE){
  ###
  # Returns the current seasons stats for all teams or just one. If raw is 
  # FALSE, it returns only the stats. If raw is TRUE, it just returns the API
  # output for the user to parse.
  ###
  
  # If raw is not a valid input, throw an error.
  if ((raw != TRUE) & (raw != FALSE)){
    stop("raw must equal TRUE or FALSE!")
  }
  # Otherwise do nothing.
  else {
    
  }
  
  # If team equals "all" the spot where ID goes in the URL will be blank.
  if (team == "all"){
    teamId = ""
  }
  # If team is a "character" type, try to look up the team id.
  else if (typeof(team) == "character"){
    teamId = findTeamId(team)
  }
  # If team is an integer, set teamId equal to team.
  else if ((typeof(team) == "double") & (team %% 1 == 0)){
    teamId = team
  }
  # Otherwise, throw an error.
  else {
    message <- paste("Please pass a team id (integer) or a full team name",
                     "e.g. 'Boston Bruins'.")
    stop(message)
  }
  
  # Paste together the URL.
  baseURL <- "https://statsapi.web.nhl.com/api/v1/teams/"
  modifier <- "?expand=team.stats"
  fullURL <- paste0(baseURL, teamId, modifier)
  # Get the data from the endpoint.
  outputAPI <- fromJSON(fullURL, flatten=TRUE)
  
  if (team != "all"){
    
    # If raw is FALSE, give back only the stats.
    if (raw == FALSE){
      teamStats <- outputAPI$teams$teamStats[[1]]$splits[[1]][1,]
      # Convert any columns that should be numeric to numeric.
      teamStats <- suppressMessages(as.data.frame(lapply(teamStats,
                                                         convertToNumeric)))
    }
    # If the user wants the raw API output, give it to them.
    else {
      teamStats <- outputAPI$teams
    }
  }
  else {
    
    # If raw is FALSE, give back only the stats.
    if (raw == FALSE){
      # Get the teamStats list where each element is a data.frame.
      output <- outputAPI$teams$teamStats
      # Count the number of teams. The last element is NULL.
      num_teams = length(output) - 1
      # Make a variable to hold just the stats, starting with the first team.
      teamStats <- output[[1]]$splits[[1]][1,]
      
      # Loop through the 2nd to the last team in the list.
      for (i in seq(2, num_teams)){
        # Select only the first row of the seasons stats for the team.
        stats <- output[[i]]$splits[[1]][1,]
        # Add the row to teamStats.
        teamStats <- rbind(teamStats, stats)
      }
    # Convert any columns that should be numeric to numeric.
    teamStats <- suppressMessages(as.data.frame(lapply(teamStats,
                                                       convertToNumeric)))
    }
    # If the user wants the raw API output, give it to them.
    else {
      teamStats <- outputAPI$teams
    }
  }
  
  # Return team stats.
  return(teamStats)
}
```

## `nhlAPI`

This function is a wrapper function for all the others above. You simply pass the name of the function you want to use, like `"seasonStats`, and any additional arguments for that function.

```{r}
nhlAPI <- function(func, ...){
  ###
  # This function is a wrapper for the other functions. It takes in the name
  # of the function to use as a character and any additional arguments for that
  # function.
  ###
  
  # Find and call the appropriate function.
  
  if (func == "franchise"){
    output <- franchise(...)
  }
  else if (func == "teamTotals"){
    output <- teamTotals(...)
  }
  else if (func == "seasonRecords"){
    output <- seasonRecords(...)
  }
  else if (func == "goalieRecords"){
    output <- goalieRecords(...)
  }
  else if (func == "skaterRecords"){
    output <- skaterRecords(...)
  }
  else if (func == "franchiseDetail"){
    output <- franchiseDetail(...)
  }
  else if (func == "seasonStats"){
    output <- seasonStats(...)
  }
  else {
    stop("Argument for func is not valid!")
  }
  return(output)
}
```

# Data Exploration

Now that we can interact with a few of the endpoints of the NHL API, let's use them.

First, let's get some data for the current season by calling `nhlAPI("seasonStats")`.

```{r }
# Get the current season stats for all of the teams in the NHL.
currentSeason <- nhlAPI("seasonStats")
```

Two variables of interest to me are shots per game and shooting percentage. I'm interested in how these two stats relate to a teams win-to-loss ratio. This variable doesn't exist, so I need to calculate it. The formula is $\text{win-loss-ratio} = \frac{wins}{losses}$. A win-loss-ratio of 1 means a team has an even record. Less than one is a losing record and more than 1 is a winning record.

```{r}
# Add a column for the win/loss ratio (wins per loss)
currentSeason <- currentSeason %>%
  mutate(win.loss.ratio = stat.wins / stat.losses)
```

My guess is these two are positively related to the win-to-loss ratio. A high shooting percentage means you are getting goals. A high number of shots per game likely means you are controlling the puck more than the other team and you have more scoring opportunities, unless you're taking wild shots. Plus, I think there is a quote from some hockey player about taking shots.

```{r}
# Read in the image.
img <- load.image("./images/Wayne Gretzky Quote.jpg")
# Display the image.
plot(img, axes=0)
```

Below I plotted the win-loss-ratio against shots per game and shooting percentage. I added a regression line as well. As expected, both are positively related to the win-loss-ratio, although there appears to be some [heteroskedasticity](https://en.wikipedia.org/wiki/Heteroscedasticity) in the plot on the right.

```{r}
# Create a ggplot object to plot shooting pct vs. shots per game.
plot1 <- ggplot(currentSeason, 
               aes(stat.shotsPerGame,
                   win.loss.ratio,
                   color=win.loss.ratio))
# Make a scatter plot.
plot1 <- plot1 + geom_point(size=4, alpha=0.75)
# Adjust the color gradient to go from blue at the low end, to red at the high
# end of win.loss.ratio
plot1 <- plot1 + scale_color_gradient(low="blue", high="red")
# Remove the legend.
plot1 <- plot1 + theme(legend.position="none")
# Add a regression line.
plot1 <- plot1 + geom_smooth(method=lm, formula=y~x, color="black")
# Add an x-axis label.
plot1 <- plot1 + scale_x_continuous("Shots per Game")
# Add an y-axis label.
plot1 <- plot1 + scale_y_continuous("Wins-Loss Ratio")
# Add a title.
plot1 <- plot1 + ggtitle("Wins/Losses vs. Shots per Game")

# Create a ggplot object to plot shooting pct vs. shots per game.
plot2 <- ggplot(currentSeason, 
               aes(stat.shootingPctg,
                   win.loss.ratio,
                   color=win.loss.ratio))
# Make a scatter plot.
plot2 <- plot2 + geom_point(size=4, alpha=0.75)
# Adjust the color gradient to go from blue at the low end, to red at the high
# end of win.loss.ratio
plot2 <- plot2 + scale_color_gradient(low="blue", high="red")
# Remove the legend.
plot2 <- plot2 + theme(legend.position="none")
# Add a regression line.
plot2 <- plot2 + geom_smooth(method=lm, formula=y~x, color="black")
# Add an x-axis label.
plot2 <- plot2 + scale_x_continuous("Shooting Percentage")
# Add an y-axis label.
plot2 <- plot2 + scale_y_continuous("Wins-Loss Ratio")
# Add a title.
plot2 <- plot2 + ggtitle("Wins/Losses vs. Shooting Perc.")

# Plot them both together.
plot_grid(plot1, plot2, ncol=2)
```

Now let's look at shooting percentage vs. shots per game. I added a color gradient for the win-loss-ratio. There doesn't appear to be a clear relationship between those two variables.

```{r}
# Create a ggplot object to plot shooting pct vs. shots per game.
plot3 <- ggplot(currentSeason, 
               aes(stat.shotsPerGame,
                   stat.shootingPctg,
                   color=win.loss.ratio))
# Make a scatter plot.
plot3 <- plot3 + geom_point(size=4, alpha=0.75)
# Adjust the color gradient to go from blue at the low end, to red at the high
# end of win.loss.ratio
plot3 <- plot3 + scale_color_gradient(low="blue", high="red",
                                    name="Wins / Losses")
# Add an x-axis label.
plot3 <- plot3 + scale_x_continuous("Shots per Game")
# Add an y-axis label.
plot3 <- plot3 + scale_y_continuous("Shooting Percentage")
# Add a title.
plot3 <- plot3 + ggtitle("Shooting Percentage vs. Shots per Game")

plot3
```

Now let's look at some total season stats. I called `nhlAPI("teamTotals")` to get the total stats for a team's history and filtered for active teams and regular season games only.

```{r}
# Get some stats for the total history of a team.
teamTotalStats <- nhlAPI("teamTotals")

# Subset for the regular season stats for active teams.
regSeasonStats <- teamTotalStats %>%
  filter(is.na(lastSeasonId) & gameTypeId == 2)
```


Not all the teams have been around for the same length of time and I want to adjust some stats, say total wins, by the length of time a team has been in the NHL. This way I can compare teams on the same basis.

To make this column, I had to convert the `firstSeasonId` column to a character, grab the first 4 characters to get the first season starting year and subtract that from 2020.

```{r}
regSeasonStats %>%
  mutate(
    seasonsInNHL = 2020 - as.numeric(substr(as.character(firstSeasonId), 1, 4))
    )

```

