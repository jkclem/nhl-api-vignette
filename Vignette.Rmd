---
title: "NHL API Vignette"
author: "John Clements"
date: "6/15/2021"
output: 
  html_document:
    toc: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Requirements

To use the functions for interacting with the [NHL API](https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md), you need to install and load:

- [`dplyr`](https://cran.r-project.org/web/packages/dplyr/): `data.frame` manipulation
- [`jsonlite`](https://cran.r-project.org/web/packages/jsonlite/): API interaction

Additionally, I used the following packages for the data exploration:

- [`ggplot2`](https://ggplot2.tidyverse.org/): data visualization
- [`cowplot`](https://cran.r-project.org/web/packages/cowplot/index.html): extra functionality for `ggplot2`

I didn't pull in the entire [`tidyverse`](https://www.tidyverse.org/) to avoid pulling in unnecessary functions.

```{r}
library(jsonlite)
library(dplyr)
library(ggplot2)
library(cowplot)
```

# Functions

## `convertToNumeric`

This a helper function used to convert columns that contain numeric data, but store `character` values, to numeric columns.

```{r}
convertToNumeric <- function(vec){
  ###
  # This function will convert the input vector to a numeric vector if it is 
  # able to. Otherwise, it just returns the vector.
  ###
  
  # If any of the values in vec return NA when trying to convert to numeric,
  # just return vec as the output.
  if (any(is.na(suppressWarnings(as.numeric(vec))) == TRUE)){
    output <- vec
  }
  # Otherwise, convert vec to a numeric vector.
  else {
    output <- as.numeric(vec)
  }
  return(output)
}
```

## `franchise`

```{r}
franchise <- function(team="all"){
  ###
  # This functions returns a dataframe with metadata on all teams who ever 
  # played in the NHL. It can also return those columns for a single team if a 
  # franchise ID or name is passed.
  ###
  
  # Get the franchise data from the franchises endpoint.
  outputAPI <- fromJSON(
      "https://records.nhl.com/site/api/franchise"
      )
  
  # Select only the dataframe.
  output <- outputAPI$data
  
  # If team does not equal "all", check if it is a franchise ID or team name.
  if (team != "all"){
    
    # If team is in the id column, subset output for just that row.
    if (team %in% output$id){
      output <- output %>%
        filter(mostRecentTeamId == team)
    }
    # If team is in the fullName column, subset output for just that row.
    else if (team %in% output$fullName){
      output <- output %>%
        filter(fullName == team)
    }
    # Otherwise, warn the user and return the entire dataframe.
    else {
      message <- paste("ERROR: Argument for team was not found in either",
                       "the fullName or id columns. Try franchise('all') to",
                       "find the team you're looking for.")
      stop(message)
    }
  }
  # Do nothing if the team value equals "all".
  else {
    
  }
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output dataframe.
  return(output)
}
```

## `teamTotals`

```{r}
teamTotals <- function(team="all"){
  ###
  # This function returns total stats for every franchise (ex roadTies,
  # roadWins, etc) unless a specific team Id or full team name is passed.
  ###
  
  # Get the franchise data from the franchises endpoint.
  outputAPI <- fromJSON(
    "https://records.nhl.com/site/api/franchise-team-totals"
    )
  
  # Select only the dataframe.
  output <- outputAPI$data
  
  # If team does not equal "all", check if it is a team ID or team name.
  if (team != "all"){
    
    # If team is in the franchiseId column, subset output for just that row.
    if (team %in% output$teamId){
      output <- output %>%
        filter(teamId == team)
    }
    # If team is in the teamName column, subset output for just that row.
    else if (team %in% output$teamName){
      output <- output %>%
        filter(teamName == team)
    }
    # Otherwise, warn the user and return the entire dataframe.
    else {
      message <- paste("WARNING: Argument for team was not found in either",
                       "the teamName or franchiseId columns. Returning all",
                       "franchises.")
      warning(message)
    }
  }
  # Do nothing if the team value equals "all".
  else {
    
  }
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output dataframe.
  return(output)
}
```

## `findTeamId`

This is a helper function to look up the most recent team id for a full team name e.g. "Boston Bruins" because I am too lazy to hard code it.

```{r}
findTeamId <- function(teamName){
  ###
  # This helper function looks up the franchise id for a full team name 
  # e.g. "Boston Bruins".
  ###
  
  # Call the franchise function with the team name.
  teamId <- franchise(teamName)
  
  # Return only the most recent team id number.
  return(teamId$mostRecentTeamId)
}
```

## `findFranchiseId`

This is a helper function to look up the franchise id for a full team name e.g. "Boston Bruins" because I am too lazy to hard code it.

```{r}
findFranchiseId <- function(teamName){
  ###
  # This helper function looks up the franchise id for a full team name 
  # e.g. "Boston Bruins".
  ###
  
  # Call the franchise function with the team name.
  teamId <- franchise(teamName)
  
  # Return only the most recent team id number.
  return(teamId$id)
}
```

## `seasonRecords`

```{r}
seasonRecords <- function(team){
  ###
  # This functions returns a dataframe with the season records for a variety 
  # of stats for a single team.
  ###
  
  # If team is a "character" type, try to look up the team id.
  if (typeof(team) == "character"){
    teamId = findFranchiseId(team)
  }
  # If team is an integer, set teamId equal to team.
  else if ((typeof(team) == "double") & (team %% 1 == 0)){
    teamId = team
  }
  # Otherwise, throw an error.
  else {
    message <- paste("Please pass a team id (integer) or a full team name",
                     "e.g. 'Boston Bruins'.")
    stop(message)
  }
  
  # Set the base url, endpoint, and combine them with teamId for the full url.
  baseURL <- "https://records.nhl.com/site/api/"
  endpoint <- "franchise-season-records?cayenneExp=franchiseId="
  fullURL <- paste0(baseURL, endpoint, teamId)
  
  # Get the API output.
  outputAPI <- fromJSON(fullURL)
  # Select only the data.
  output <- outputAPI$data
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output from the request.
  return(output)
}
```

## `goalieRecords`

```{r}
goalieRecords <- function(team){
  ###
  # This functions returns a dataframe with the goalie records for a team.
  ###
  
  # If team is a "character" type, try to look up the team id.
  if (typeof(team) == "character"){
    teamId = findFranchiseId(team)
  }
  # If team is an integer, set teamId equal to team.
  else if ((typeof(team) == "double") & (team %% 1 == 0)){
    teamId = team
  }
  # Otherwise, throw an error.
  else {
    message <- paste("Please pass a team id (integer) or a full team name",
                     "e.g. 'Boston Bruins'.")
    stop(message)
  }
  
  # Set the base url, endpoint, and combine them with teamId for the full url.
  baseURL <- "https://records.nhl.com/site/api/"
  endpoint <- "franchise-goalie-records?cayenneExp=franchiseId="
  fullURL <- paste0(baseURL, endpoint, teamId)
  
  # Get the API output.
  outputAPI <- fromJSON(fullURL)
  # Select only the data.
  output <- outputAPI$data
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output from the request.
  return(output)
}
```

## `skaterRecords`

```{r}
skaterRecords <- function(team){
  ###
  # This functions returns a dataframe with the skater records for a team.
  ###
  
  # If team is a "character" type, try to look up the team id.
  if (typeof(team) == "character"){
    teamId = findFranchiseId(team)
  }
  # If team is an integer, set teamId equal to team.
  else if ((typeof(team) == "double") & (team %% 1 == 0)){
    teamId = team
  }
  # Otherwise, throw an error.
  else {
    message <- paste("Please pass a team id (integer) or a full team name",
                     "e.g. 'Boston Bruins'.")
    stop(message)
  }
  
  # Set the base url, endpoint, and combine them with teamId for the full url.
  baseURL <- "https://records.nhl.com/site/api/"
  endpoint <- "franchise-skater-records?cayenneExp=franchiseId="
  fullURL <- paste0(baseURL, endpoint, teamId)
  
  # Get the API output.
  outputAPI <- fromJSON(fullURL)
  # Select only the data.
  output <- outputAPI$data
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output from the request.
  return(output)
}
```

## `franchiseDetail`

```{r}
franchiseDetail <- function(team){
  ###
  # This functions returns a dataframe with the data for a team.
  ###
  
  # If team is a "character" type, try to look up the team id.
  if (typeof(team) == "character"){
    teamId = findTeamId(team)
  }
  # If team is an integer, set teamId equal to team.
  else if ((typeof(team) == "double") & (team %% 1 == 0)){
    teamId = team
  }
  # Otherwise, throw an error.
  else {
    message <- paste("Please pass a team id (integer) or a full team name",
                     "e.g. 'Boston Bruins'.")
    stop(message)
  }
  
  # Set the base url, endpoint, and combine them with teamId for the full url.
  baseURL <- "https://records.nhl.com/site/api/"
  endpoint <- "franchise-detail?cayenneExp=mostRecentTeamId="
  fullURL <- paste0(baseURL, endpoint, teamId)
  
  # Get the API output.
  outputAPI <- fromJSON(fullURL)
  # Select only the data.
  output <- outputAPI$data
  
  # Convert any columns that should be numeric to numeric.
  output <- suppressMessages(as.data.frame(lapply(output, convertToNumeric)))
  
  # Return the output from the request.
  return(output)
}
```

## `seasonStats`

```{r}
seasonStats <- function(team="all", raw=FALSE){
  ###
  # Returns the current seasons stats for all teams or just one. If raw is 
  # FALSE, it returns only the stats. If raw is TRUE, it just returns the API
  # output for the user to parse.
  ###
  
  # If raw is not a valid input, throw an error.
  if ((raw != TRUE) & (raw != FALSE)){
    stop("raw must equal TRUE or FALSE!")
  }
  # Otherwise do nothing.
  else {
    
  }
  
  # If team equals "all" the spot where ID goes in the URL will be blank.
  if (team == "all"){
    teamId = ""
  }
  # If team is a "character" type, try to look up the team id.
  else if (typeof(team) == "character"){
    teamId = findTeamId(team)
  }
  # If team is an integer, set teamId equal to team.
  else if ((typeof(team) == "double") & (team %% 1 == 0)){
    teamId = team
  }
  # Otherwise, throw an error.
  else {
    message <- paste("Please pass a team id (integer) or a full team name",
                     "e.g. 'Boston Bruins'.")
    stop(message)
  }
  
  # Paste together the URL.
  baseURL <- "https://statsapi.web.nhl.com/api/v1/teams/"
  modifier <- "?expand=team.stats"
  fullURL <- paste0(baseURL, teamId, modifier)
  # Get the data from the endpoint.
  outputAPI <- fromJSON(fullURL, flatten=TRUE)
  
  if (team != "all"){
    
    # If raw is FALSE, give back only the stats.
    if (raw == FALSE){
      teamStats <- outputAPI$teams$teamStats[[1]]$splits[[1]][1,]
      # Convert any columns that should be numeric to numeric.
      teamStats <- suppressMessages(as.data.frame(lapply(teamStats,
                                                         convertToNumeric)))
    }
    # If the user wants the raw API output, give it to them.
    else {
      teamStats <- outputAPI$teams
    }
  }
  else {
    
    # If raw is FALSE, give back only the stats.
    if (raw == FALSE){
      # Get the teamStats list where each element is a data.frame.
      output <- outputAPI$teams$teamStats
      # Count the number of teams. The last element is NULL.
      num_teams = length(output) - 1
      # Make a variable to hold just the stats, starting with the first team.
      teamStats <- output[[1]]$splits[[1]][1,]
      
      # Loop through the 2nd to the last team in the list.
      for (i in seq(2, num_teams)){
        # Select only the first row of the seasons stats for the team.
        stats <- output[[i]]$splits[[1]][1,]
        # Add the row to teamStats.
        teamStats <- rbind(teamStats, stats)
      }
    # Convert any columns that should be numeric to numeric.
    teamStats <- suppressMessages(as.data.frame(lapply(teamStats,
                                                       convertToNumeric)))
    }
    # If the user wants the raw API output, give it to them.
    else {
      teamStats <- outputAPI$teams
    }
  }
  
  
  
  # Return team stats.
  return(teamStats)
}
```

## `nhlAPI`

```{r}
nhlAPI <- function(func, ...){
  ###
  # This function is a wrapper for the other functions. It takes in the name
  # of the function to use as a character and any additional arguments for that
  # function.
  ###
  
  # Find and call the appropriate function.
  
  if (func == "franchise"){
    output <- franchise(...)
  }
  else if (func == "teamTotals"){
    output <- teamTotals(...)
  }
  else if (func == "seasonRecords"){
    output <- seasonRecords(...)
  }
  else if (func == "goalieRecords"){
    output <- goalieRecords(...)
  }
  else if (func == "skaterRecords"){
    output <- skaterRecords(...)
  }
  else if (func == "franchiseDetail"){
    output <- franchiseDetail(...)
  }
  else if (func == "seasonStats"){
    output <- seasonStats(...)
  }
  else {
    stop("Argument for func is not valid!")
  }
  return(output)
}
```

# Data Exploration

```{r}
# Get the current season stats for all of the teams in the NHL.
currentSeason <- nhlAPI("seasonStats")

# Add a column for the win/loss ratio (wins per loss)
currentSeason <- currentSeason %>%
  mutate(win.loss.ratio = stat.wins / stat.losses)
```


```{r}
# Create a ggplot object to plot shooting pct vs. shots per game.
plot1 <- ggplot(currentSeason, 
               aes(stat.shotsPerGame,
                   stat.shootingPctg,
                   color=win.loss.ratio))
# Make a scatter plot.
plot1 <- plot1 + geom_point(size=4, alpha=0.75)
# Adjust the color gradient to go from blue at the low end, to red at the high
# end of win.loss.ratio
plot1 <- plot1 + scale_color_gradient(low="blue", high="red",
                                    name="Wins / Losses")
# Add an x-axis label.
plot1 <- plot1 + scale_x_continuous("Shots per Game")
# Add an y-axis label.
plot1 <- plot1 + scale_y_continuous("Shooting Percentage")
# Add a title.
plot1 <- plot1 + ggtitle("Shooting Percentage vs. Shots per Game")

plot1
```

```{r}
# Create a ggplot object to plot shooting pct vs. shots per game.
plot2 <- ggplot(currentSeason, 
               aes(stat.shotsPerGame,
                   win.loss.ratio,
                   color=win.loss.ratio))
# Make a scatter plot.
plot2 <- plot2 + geom_point(size=4, alpha=0.75)
# Adjust the color gradient to go from blue at the low end, to red at the high
# end of win.loss.ratio
plot2 <- plot2 + scale_color_gradient(low="blue", high="red")
# Remove the legend.
plot2 <- plot2 + theme(legend.position="none")
# Add a regression line.
plot2 <- plot2 + geom_smooth(method=lm, formula=y~x, color="black")
# Add an x-axis label.
plot2 <- plot2 + scale_x_continuous("Shots per Game")
# Add an y-axis label.
plot2 <- plot2 + scale_y_continuous("Wins-Loss Ratio")
# Add a title.
plot2 <- plot2 + ggtitle("Wins/Losses vs. Shots per Game")

# Create a ggplot object to plot shooting pct vs. shots per game.
plot3 <- ggplot(currentSeason, 
               aes(stat.shootingPctg,
                   win.loss.ratio,
                   color=win.loss.ratio))
# Make a scatter plot.
plot3 <- plot3 + geom_point(size=4, alpha=0.75)
# Adjust the color gradient to go from blue at the low end, to red at the high
# end of win.loss.ratio
plot3 <- plot3 + scale_color_gradient(low="blue", high="red")
# Remove the legend.
plot3 <- plot3 + theme(legend.position="none")
# Add a regression line.
plot3 <- plot3 + geom_smooth(method=lm, formula=y~x, color="black")
# Add an x-axis label.
plot3 <- plot3 + scale_x_continuous("Shooting Percentage")
# Add an y-axis label.
plot3 <- plot3 + scale_y_continuous("Wins-Loss Ratio")
# Add a title.
plot3 <- plot3 + ggtitle("Wins/Losses vs. Shooting Perc.")

# Plot them both together.
plot_grid(plot2, plot3, ncol=2)
```








